<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker - Voting Interface</title>
    <style>
        .voting-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .session-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .current-story {
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .story-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        
        .story-description {
            font-size: 1.1em;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .voting-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .voting-card {
            width: 80px;
            height: 120px;
            border: 3px solid #007bff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #007bff;
        }
        
        .voting-card:hover {
            background: #007bff;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        .voting-card.selected {
            background: #28a745;
            border-color: #28a745;
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }
        
        .participants {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .participant {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .participant.voted {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .participant.revealed .vote {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        
        .controls {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .results {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .vote-summary {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .vote-stat {
            text-align: center;
        }
        
        .vote-stat .number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .vote-stat .label {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="voting-container">
        <!-- Session Information -->
        <div class="session-info">
            <h2 id="sessionName">Loading Session...</h2>
            <p>Facilitator: <span id="facilitatorName"></span></p>
            <p>Scoring Method: <span id="scoringMethod"></span></p>
            <p>Status: <span id="sessionStatus"></span></p>
        </div>
        
        <!-- Current Story -->
        <div class="current-story" id="currentStory">
            <div class="story-title" id="storyTitle">Select a story to begin voting</div>
            <div class="story-description" id="storyDescription"></div>
            
            <!-- Voting Cards -->
            <div class="voting-cards" id="votingCards" style="display: none;">
                <!-- Cards will be populated by JavaScript -->
            </div>
            
            <!-- My Vote Display -->
            <div id="myVote" style="display: none; text-align: center; margin: 20px 0;">
                <p>Your vote: <span id="myVoteValue" style="font-size: 1.5em; font-weight: bold; color: #28a745;"></span></p>
            </div>
        </div>
        
        <!-- Participants -->
        <div class="participants" id="participants">
            <!-- Participants will be populated by JavaScript -->
        </div>
        
        <!-- Controls (Facilitator Only) -->
        <div class="controls" id="facilitatorControls" style="display: none;">
            <button class="btn btn-primary" onclick="startVoting()">Start Voting</button>
            <button class="btn btn-success" onclick="revealVotes()">Reveal Votes</button>
            <button class="btn btn-secondary" onclick="nextStory()">Next Story</button>
            <button class="btn btn-secondary" onclick="resetVoting()">Reset Voting</button>
        </div>
        
        <!-- Results -->
        <div class="results" id="results" style="display: none;">
            <h3>Voting Results</h3>
            <div class="vote-summary" id="voteSummary">
                <!-- Vote statistics will be populated here -->
            </div>
            <div id="consensusMessage"></div>
        </div>
    </div>

    <script>
        // Planning Poker Voting Interface JavaScript
        
        // Global variables
        let currentSession = null;
        let currentStory = null;
        let myVote = null;
        let participants = [];
        let votes = {};
        let isRevealed = false;
        let isFacilitator = false;
        
        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            loadSession();
            setupEventListeners();
        });
        
        // Load session data
        function loadSession() {
            // Get session ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            if (!sessionId) {
                alert('No session ID provided');
                return;
            }
            
            // Make AJAX call to get session data
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'getSession');
            ajax.addParam('sysparm_session_id', sessionId);
            ajax.getXMLAnswer(function(response) {
                try {
                    const sessionData = JSON.parse(response);
                    currentSession = sessionData;
                    updateSessionDisplay();
                    loadParticipants();
                    loadCurrentStory();
                } catch (e) {
                    console.error('Error loading session:', e);
                }
            });
        }
        
        // Update session display
        function updateSessionDisplay() {
            if (!currentSession) return;
            
            document.getElementById('sessionName').textContent = currentSession.name;
            document.getElementById('facilitatorName').textContent = currentSession.facilitator_name;
            document.getElementById('scoringMethod').textContent = currentSession.scoring_method_name;
            document.getElementById('sessionStatus').textContent = currentSession.status;
            
            // Show facilitator controls if user is facilitator
            isFacilitator = currentSession.is_facilitator;
            if (isFacilitator) {
                document.getElementById('facilitatorControls').style.display = 'block';
            }
        }
        
        // Load participants
        function loadParticipants() {
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'getParticipants');
            ajax.addParam('sysparm_session_id', currentSession.sys_id);
            ajax.getXMLAnswer(function(response) {
                try {
                    participants = JSON.parse(response);
                    updateParticipantsDisplay();
                } catch (e) {
                    console.error('Error loading participants:', e);
                }
            });
        }
        
        // Update participants display
        function updateParticipantsDisplay() {
            const container = document.getElementById('participants');
            container.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'participant';
                div.id = 'participant_' + participant.sys_id;
                
                const hasVoted = votes[participant.sys_id] !== undefined;
                if (hasVoted) {
                    div.classList.add('voted');
                }
                
                let voteDisplay = '';
                if (isRevealed && hasVoted) {
                    div.classList.add('revealed');
                    voteDisplay = `<div class="vote">${votes[participant.sys_id]}</div>`;
                } else if (hasVoted) {
                    voteDisplay = '<div class="vote">✓</div>';
                }
                
                div.innerHTML = `
                    <div class="name">${participant.name}</div>
                    ${voteDisplay}
                `;
                
                container.appendChild(div);
            });
        }
        
        // Load current story
        function loadCurrentStory() {
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'getCurrentStory');
            ajax.addParam('sysparm_session_id', currentSession.sys_id);
            ajax.getXMLAnswer(function(response) {
                try {
                    const storyData = JSON.parse(response);
                    if (storyData && storyData.sys_id) {
                        currentStory = storyData;
                        updateStoryDisplay();
                        loadVotingCards();
                        loadVotes();
                    }
                } catch (e) {
                    console.error('Error loading story:', e);
                }
            });
        }
        
        // Update story display
        function updateStoryDisplay() {
            if (!currentStory) return;
            
            document.getElementById('storyTitle').textContent = currentStory.story_title;
            document.getElementById('storyDescription').textContent = currentStory.story_description;
            
            if (currentStory.status === 'voting') {
                document.getElementById('votingCards').style.display = 'flex';
            }
        }
        
        // Load voting cards
        function loadVotingCards() {
            if (!currentSession.scoring_method_values) return;
            
            const container = document.getElementById('votingCards');
            container.innerHTML = '';
            
            const values = currentSession.scoring_method_values.split(',');
            
            values.forEach(value => {
                const card = document.createElement('div');
                card.className = 'voting-card';
                card.textContent = value.trim();
                card.onclick = () => castVote(value.trim());
                container.appendChild(card);
            });
        }
        
        // Cast vote
        function castVote(value) {
            if (!currentStory || currentStory.status !== 'voting') {
                alert('Voting is not currently active for this story');
                return;
            }
            
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'castVote');
            ajax.addParam('sysparm_story_id', currentStory.sys_id);
            ajax.addParam('sysparm_vote_value', value);
            ajax.getXMLAnswer(function(response) {
                if (response === 'success') {
                    myVote = value;
                    updateMyVoteDisplay();
                    updateVotingCardsSelection();
                    // Refresh votes to show updated participant status
                    loadVotes();
                } else {
                    alert('Error casting vote: ' + response);
                }
            });
        }
        
        // Update my vote display
        function updateMyVoteDisplay() {
            if (myVote) {
                document.getElementById('myVoteValue').textContent = myVote;
                document.getElementById('myVote').style.display = 'block';
            }
        }
        
        // Update voting cards selection
        function updateVotingCardsSelection() {
            const cards = document.querySelectorAll('.voting-card');
            cards.forEach(card => {
                card.classList.remove('selected');
                if (card.textContent === myVote) {
                    card.classList.add('selected');
                }
            });
        }
        
        // Load votes
        function loadVotes() {
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'getVotes');
            ajax.addParam('sysparm_story_id', currentStory.sys_id);
            ajax.getXMLAnswer(function(response) {
                try {
                    const voteData = JSON.parse(response);
                    votes = voteData.votes;
                    myVote = voteData.my_vote;
                    isRevealed = voteData.is_revealed;
                    
                    updateMyVoteDisplay();
                    updateVotingCardsSelection();
                    updateParticipantsDisplay();
                    
                    if (isRevealed) {
                        showResults();
                    }
                } catch (e) {
                    console.error('Error loading votes:', e);
                }
            });
        }
        
        // Facilitator functions
        function startVoting() {
            if (!isFacilitator) return;
            
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'startVoting');
            ajax.addParam('sysparm_story_id', currentStory.sys_id);
            ajax.getXMLAnswer(function(response) {
                if (response === 'success') {
                    currentStory.status = 'voting';
                    updateStoryDisplay();
                } else {
                    alert('Error starting voting: ' + response);
                }
            });
        }
        
        function revealVotes() {
            if (!isFacilitator) return;
            
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'revealVotes');
            ajax.addParam('sysparm_story_id', currentStory.sys_id);
            ajax.getXMLAnswer(function(response) {
                if (response === 'success') {
                    isRevealed = true;
                    loadVotes(); // Refresh to show revealed votes
                } else {
                    alert('Error revealing votes: ' + response);
                }
            });
        }
        
        function resetVoting() {
            if (!isFacilitator) return;
            
            if (confirm('Are you sure you want to reset voting for this story?')) {
                var ajax = new GlideAjax('PlanningPokerAjax');
                ajax.addParam('sysparm_name', 'resetVoting');
                ajax.addParam('sysparm_story_id', currentStory.sys_id);
                ajax.getXMLAnswer(function(response) {
                    if (response === 'success') {
                        votes = {};
                        myVote = null;
                        isRevealed = false;
                        updateMyVoteDisplay();
                        updateVotingCardsSelection();
                        updateParticipantsDisplay();
                        document.getElementById('results').style.display = 'none';
                    } else {
                        alert('Error resetting votes: ' + response);
                    }
                });
            }
        }
        
        function nextStory() {
            if (!isFacilitator) return;
            
            var ajax = new GlideAjax('PlanningPokerAjax');
            ajax.addParam('sysparm_name', 'nextStory');
            ajax.addParam('sysparm_session_id', currentSession.sys_id);
            ajax.getXMLAnswer(function(response) {
                if (response !== 'no_more_stories') {
                    loadCurrentStory();
                    document.getElementById('results').style.display = 'none';
                } else {
                    alert('No more stories to vote on');
                }
            });
        }
        
        // Show results
        function showResults() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('voteSummary');
            
            // Calculate vote statistics
            const voteValues = Object.values(votes);
            const voteStats = {};
            let total = 0;
            let sum = 0;
            
            voteValues.forEach(vote => {
                voteStats[vote] = (voteStats[vote] || 0) + 1;
                total++;
                if (!isNaN(vote)) {
                    sum += parseFloat(vote);
                }
            });
            
            // Display statistics
            summaryDiv.innerHTML = `
                <div class="vote-stat">
                    <div class="number">${total}</div>
                    <div class="label">Total Votes</div>
                </div>
                <div class="vote-stat">
                    <div class="number">${total > 0 ? (sum / total).toFixed(1) : '0'}</div>
                    <div class="label">Average</div>
                </div>
                <div class="vote-stat">
                    <div class="number">${Object.keys(voteStats).length}</div>
                    <div class="label">Unique Values</div>
                </div>
            `;
            
            // Check for consensus
            const consensusDiv = document.getElementById('consensusMessage');
            if (Object.keys(voteStats).length === 1 && total > 1) {
                consensusDiv.innerHTML = '<p style="color: #28a745; font-weight: bold;">🎉 Consensus achieved!</p>';
            } else {
                consensusDiv.innerHTML = '<p style="color: #dc3545;">No consensus - consider discussion and re-voting</p>';
            }
            
            resultsDiv.style.display = 'block';
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Auto-refresh every 5 seconds when voting is active
            setInterval(() => {
                if (currentStory && currentStory.status === 'voting' && !isRevealed) {
                    loadVotes();
                }
            }, 5000);
        }
    </script>
</body>
</html>